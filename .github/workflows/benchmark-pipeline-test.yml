name: Benchmark Pipeline Test

on: [push]

jobs:
  setup_kind_cluster:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main
      - name: Setup Kind cluster
        uses: helm/kind-action@main
        with:
          config: hack/kind-config.yaml
      - run: flux install
      - uses: azure/setup-kubectl@v4
      - name: Bootstrap cluster
        run: |
          kubectl apply -f clusters/base/monitoring-namespace.yaml
          kubectl apply -f clusters/base/

          sleep 20

          flux reconcile helmrelease -n flux-system kepler

          kubectl wait pod \
          --all \
          --for=condition=Ready \
          --namespace monitoring
      - name: Generate kubeconfig
        run: |
          ./scripts/gen-kubeconfig.sh pipeline
          ls -l
  
  test_pipeline:
    uses: .github/workflows/benchmark-pipeline.yaml@${{ github.ref_name }}
    with:
      cncf_project: falco
      config: modern-ebpf
      version: 0.39.2
      benchmark_job_url: 	https://raw.githubusercontent.com/falcosecurity/cncf-green-review-testing/e93136094735c1a52cbbef3d7e362839f26f4944/benchmark-tests/falco-benchmark-tests.yaml
      benchmark_job_duration_mins: 2
